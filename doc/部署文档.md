# Nano Bananary 部署文档

## 1. 部署概述

### 1.1 部署架构

Nano Bananary 是一个基于React的单页面应用（SPA），采用前端静态部署的架构模式。应用通过调用Google Gemini AI API提供图像处理服务。

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   用户浏览器     │────│   静态Web服务器   │────│  Google Gemini  │
│   (Frontend)    │    │   (Nginx/CDN)    │    │     AI API      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 1.2 部署方式

支持多种部署方式：
- **静态托管**：Netlify、Vercel、GitHub Pages
- **云服务器**：阿里云、腾讯云、AWS
- **容器化部署**：Docker、Kubernetes
- **CDN部署**：CloudFlare、AWS CloudFront

### 1.3 系统要求

#### 1.3.1 开发环境要求
- **Node.js**: 18.0.0+
- **npm**: 8.0.0+
- **Git**: 2.20.0+
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+

#### 1.3.2 生产环境要求
- **Web服务器**: Nginx 1.18+, Apache 2.4+
- **HTTPS支持**: SSL证书配置
- **域名**: 可选，支持自定义域名
- **CDN**: 推荐使用CDN加速

## 2. 环境准备

### 2.1 API密钥配置

#### 2.1.1 获取Google Gemini API密钥

1. **访问Google AI Studio**
   ```
   https://makersuite.google.com/app/apikey
   ```

2. **创建API密钥**
   - 登录Google账户
   - 点击"Create API Key"
   - 选择项目或创建新项目
   - 复制生成的API密钥

3. **API密钥格式验证**
   ```
   正确格式：AIzaSyD...(39个字符)
   示例：AIzaSyDXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
   ```

#### 2.1.2 环境变量配置

**开发环境** (`.env`):
```bash
# Google Gemini AI API配置
VITE_API_KEY=your_google_gemini_api_key_here

# 应用配置
VITE_APP_NAME=Nano Bananary
VITE_APP_VERSION=1.0.0

# 调试配置
VITE_DEBUG_MODE=false
VITE_LOG_LEVEL=info
```

**生产环境**:
```bash
# 生产环境变量
VITE_API_KEY=your_production_api_key
VITE_DEBUG_MODE=false
VITE_LOG_LEVEL=error

# 性能配置
VITE_ENABLE_ANALYTICS=true
VITE_CDN_URL=https://your-cdn-domain.com
```

### 2.2 依赖安装

#### 2.2.1 项目克隆
```bash
# 克隆项目
git clone https://github.com/your-username/Nano-Bananary.git
cd Nano-Bananary

# 检查Node.js版本
node --version  # 应该 >= 18.0.0
npm --version   # 应该 >= 8.0.0
```

#### 2.2.2 依赖安装
```bash
# 安装项目依赖
npm install

# 或使用yarn（如果已安装）
yarn install

# 验证安装
npm list --depth=0
```

#### 2.2.3 依赖审计
```bash
# 检查安全漏洞
npm audit

# 自动修复（如果可能）
npm audit fix

# 检查过时的包
npm outdated
```

## 3. 本地部署

### 3.1 开发环境部署

#### 3.1.1 启动开发服务器
```bash
# 启动开发服务器
npm run dev

# 指定端口启动
npm run dev -- --port 3001

# 指定主机启动（允许外部访问）
npm run dev -- --host 0.0.0.0
```

#### 3.1.2 开发服务器配置

**vite.config.ts** 开发配置:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    host: '0.0.0.0', // 允许外部访问
    open: true,       // 自动打开浏览器
    cors: true,       // 启用CORS
    proxy: {
      // 如果需要代理API请求
      '/api': {
        target: 'https://api.example.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  },
  define: {
    'process.env': process.env
  }
})
```

### 3.2 生产构建

#### 3.2.1 构建命令
```bash
# 生产构建
npm run build

# 构建并分析包大小
npm run build -- --analyze

# 预览构建结果
npm run preview
```

#### 3.2.2 构建优化配置

**vite.config.ts** 生产配置:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { resolve } from 'path'

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: 'dist',
    sourcemap: false, // 生产环境关闭sourcemap
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true, // 移除console.log
        drop_debugger: true // 移除debugger
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          // 代码分割
          vendor: ['react', 'react-dom'],
          ai: ['@google/genai']
        },
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: 'assets/[ext]/[name]-[hash].[ext]'
      }
    },
    chunkSizeWarningLimit: 1000
  },
  define: {
    'process.env': process.env
  }
})
```

#### 3.2.3 构建验证
```bash
# 检查构建产物
ls -la dist/

# 分析构建大小
du -sh dist/*

# 验证HTML文件
cat dist/index.html

# 启动本地预览服务器
npm run preview
```

## 4. 静态托管部署

### 4.1 Netlify部署

#### 4.1.1 自动部署配置

**netlify.toml** 配置文件:
```toml
[build]
  publish = "dist"
  command = "npm run build"

[build.environment]
  NODE_VERSION = "18"
  NPM_VERSION = "8"

# 重定向规则（SPA路由支持）
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# 头部设置
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# 环境变量（在Netlify控制台设置）
# VITE_API_KEY = "your_api_key"
```

#### 4.1.2 部署步骤

1. **连接Git仓库**
   ```bash
   # 推送代码到GitHub
   git add .
   git commit -m "feat: add netlify deployment config"
   git push origin main
   ```

2. **Netlify控制台配置**
   - 登录 https://netlify.com
   - 点击"New site from Git"
   - 选择GitHub仓库
   - 配置构建设置：
     - Build command: `npm run build`
     - Publish directory: `dist`

3. **环境变量设置**
   ```
   Site settings → Environment variables
   
   添加变量：
   VITE_API_KEY = your_google_gemini_api_key
   ```

4. **自定义域名**（可选）
   ```
   Domain settings → Custom domains
   
   添加域名：your-domain.com
   配置DNS：CNAME记录指向netlify域名
   ```

### 4.2 Vercel部署

#### 4.2.1 配置文件

**vercel.json** 配置:
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    }
  ],
  "routes": [
    {
      "src": "/assets/(.*)",
      "headers": {
        "Cache-Control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "env": {
    "VITE_API_KEY": "@vite_api_key"
  }
}
```

#### 4.2.2 部署步骤

1. **安装Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **登录和部署**
   ```bash
   # 登录Vercel
   vercel login
   
   # 部署项目
   vercel
   
   # 生产部署
   vercel --prod
   ```

3. **环境变量配置**
   ```bash
   # 添加环境变量
   vercel env add VITE_API_KEY
   
   # 查看环境变量
   vercel env ls
   ```

### 4.3 GitHub Pages部署

#### 4.3.1 GitHub Actions配置

**.github/workflows/deploy.yml**:
```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build
      run: npm run build
      env:
        VITE_API_KEY: ${{ secrets.VITE_API_KEY }}
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
```

#### 4.3.2 配置步骤

1. **启用GitHub Pages**
   ```
   Repository Settings → Pages
   Source: Deploy from a branch
   Branch: gh-pages
   ```

2. **添加Secrets**
   ```
   Repository Settings → Secrets and variables → Actions
   
   添加Secret：
   VITE_API_KEY = your_google_gemini_api_key
   ```

3. **配置基础路径**（如果使用子路径）
   ```typescript
   // vite.config.ts
   export default defineConfig({
     base: '/Nano-Bananary/', // 仓库名
     // ... 其他配置
   })
   ```

## 5. 服务器部署

### 5.1 Nginx部署

#### 5.1.1 Nginx安装

**Ubuntu/Debian**:
```bash
# 更新包列表
sudo apt update

# 安装Nginx
sudo apt install nginx

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 检查状态
sudo systemctl status nginx
```

**CentOS/RHEL**:
```bash
# 安装Nginx
sudo yum install nginx

# 或使用dnf（较新版本）
sudo dnf install nginx

# 启动服务
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 5.1.2 Nginx配置

**/etc/nginx/sites-available/nano-bananary**:
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 网站根目录
    root /var/www/nano-bananary/dist;
    index index.html;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # HTML文件不缓存
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://generativelanguage.googleapis.com;" always;
    
    # 日志配置
    access_log /var/log/nginx/nano-bananary.access.log;
    error_log /var/log/nginx/nano-bananary.error.log;
}
```

#### 5.1.3 部署步骤

1. **上传构建文件**
   ```bash
   # 创建网站目录
   sudo mkdir -p /var/www/nano-bananary
   
   # 上传dist目录内容
   sudo cp -r dist/* /var/www/nano-bananary/
   
   # 设置权限
   sudo chown -R www-data:www-data /var/www/nano-bananary
   sudo chmod -R 755 /var/www/nano-bananary
   ```

2. **启用站点配置**
   ```bash
   # 创建软链接
   sudo ln -s /etc/nginx/sites-available/nano-bananary /etc/nginx/sites-enabled/
   
   # 测试配置
   sudo nginx -t
   
   # 重载Nginx
   sudo systemctl reload nginx
   ```

3. **SSL证书配置**（使用Let's Encrypt）
   ```bash
   # 安装Certbot
   sudo apt install certbot python3-certbot-nginx
   
   # 获取证书
   sudo certbot --nginx -d your-domain.com -d www.your-domain.com
   
   # 自动续期
   sudo crontab -e
   # 添加：0 12 * * * /usr/bin/certbot renew --quiet
   ```

### 5.2 Apache部署

#### 5.2.1 Apache配置

**/etc/apache2/sites-available/nano-bananary.conf**:
```apache
<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    Redirect permanent / https://your-domain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    DocumentRoot /var/www/nano-bananary/dist
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    
    # 启用压缩
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # 缓存配置
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </LocationMatch>
    
    # SPA路由支持
    <Directory /var/www/nano-bananary/dist>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # 安全头部
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    
    # 日志
    ErrorLog ${APACHE_LOG_DIR}/nano-bananary_error.log
    CustomLog ${APACHE_LOG_DIR}/nano-bananary_access.log combined
</VirtualHost>
```

#### 5.2.2 启用模块和站点
```bash
# 启用必要模块
sudo a2enmod rewrite
sudo a2enmod ssl
sudo a2enmod headers
sudo a2enmod expires
sudo a2enmod deflate

# 启用站点
sudo a2ensite nano-bananary.conf

# 重启Apache
sudo systemctl restart apache2
```

## 6. 容器化部署

### 6.1 Docker部署

#### 6.1.1 Dockerfile

**多阶段构建Dockerfile**:
```dockerfile
# 构建阶段
FROM node:18-alpine as builder

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

# 暴露端口
EXPOSE 80

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

# 启动命令
CMD ["nginx", "-g", "daemon off;"]
```

#### 6.1.2 Nginx配置文件

**nginx.conf**:
```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    server {
        listen 80;
        server_name localhost;
        
        root /usr/share/nginx/html;
        index index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # HTML文件不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # SPA路由支持
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # 安全头部
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
}
```

#### 6.1.3 Docker Compose配置

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  nano-bananary:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_KEY=${VITE_API_KEY}
    ports:
      - "80:80"
      - "443:443"
    environment:
      - NODE_ENV=production
    volumes:
      - ./ssl:/etc/nginx/ssl:ro  # SSL证书挂载
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nano-bananary.rule=Host(`your-domain.com`)"
      - "traefik.http.routers.nano-bananary.tls=true"
      - "traefik.http.routers.nano-bananary.tls.certresolver=letsencrypt"

  # 可选：添加反向代理
  traefik:
    image: traefik:v2.9
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
    restart: unless-stopped
```

#### 6.1.4 部署命令

```bash
# 构建镜像
docker build -t nano-bananary:latest .

# 运行容器
docker run -d \
  --name nano-bananary \
  -p 80:80 \
  -e VITE_API_KEY=your_api_key \
  nano-bananary:latest

# 使用Docker Compose
docker-compose up -d

# 查看日志
docker logs nano-bananary

# 更新部署
docker-compose pull
docker-compose up -d
```

### 6.2 Kubernetes部署

#### 6.2.1 Deployment配置

**k8s/deployment.yaml**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nano-bananary
  labels:
    app: nano-bananary
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nano-bananary
  template:
    metadata:
      labels:
        app: nano-bananary
    spec:
      containers:
      - name: nano-bananary
        image: nano-bananary:latest
        ports:
        - containerPort: 80
        env:
        - name: VITE_API_KEY
          valueFrom:
            secretKeyRef:
              name: nano-bananary-secrets
              key: api-key
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: nano-bananary-service
spec:
  selector:
    app: nano-bananary
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nano-bananary-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  tls:
  - hosts:
    - your-domain.com
    secretName: nano-bananary-tls
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nano-bananary-service
            port:
              number: 80
```

#### 6.2.2 Secret配置

**k8s/secrets.yaml**:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: nano-bananary-secrets
type: Opaque
data:
  api-key: <base64-encoded-api-key>
```

#### 6.2.3 部署命令

```bash
# 创建Secret
kubectl create secret generic nano-bananary-secrets \
  --from-literal=api-key=your_google_gemini_api_key

# 应用配置
kubectl apply -f k8s/

# 查看部署状态
kubectl get deployments
kubectl get pods
kubectl get services
kubectl get ingress

# 查看日志
kubectl logs -l app=nano-bananary

# 扩缩容
kubectl scale deployment nano-bananary --replicas=5
```

## 7. CDN和性能优化

### 7.1 CloudFlare配置

#### 7.1.1 DNS配置
```
类型    名称    内容                TTL
A       @       your-server-ip      自动
CNAME   www     your-domain.com     自动
```

#### 7.1.2 缓存规则
```
页面规则：
- your-domain.com/assets/*
  缓存级别：缓存所有内容
  边缘缓存TTL：1个月
  浏览器缓存TTL：1年

- your-domain.com/*.html
  缓存级别：绕过缓存
  
- your-domain.com/*
  缓存级别：标准
  浏览器缓存TTL：4小时
```

#### 7.1.3 安全设置
```
SSL/TLS：
- 加密模式：完全（严格）
- 最低TLS版本：1.2
- 自动HTTPS重写：开启
- HSTS：开启

防火墙：
- 安全级别：中等
- 机器人对抗模式：开启
- 质询通道：开启
```

### 7.2 AWS CloudFront配置

#### 7.2.1 分发配置
```json
{
  "DistributionConfig": {
    "CallerReference": "nano-bananary-2024",
    "Comment": "Nano Bananary CDN Distribution",
    "DefaultRootObject": "index.html",
    "Origins": {
      "Quantity": 1,
      "Items": [
        {
          "Id": "nano-bananary-origin",
          "DomainName": "your-origin-domain.com",
          "CustomOriginConfig": {
            "HTTPPort": 80,
            "HTTPSPort": 443,
            "OriginProtocolPolicy": "https-only"
          }
        }
      ]
    },
    "DefaultCacheBehavior": {
      "TargetOriginId": "nano-bananary-origin",
      "ViewerProtocolPolicy": "redirect-to-https",
      "CachePolicyId": "managed-caching-optimized",
      "OriginRequestPolicyId": "managed-cors-s3-origin",
      "ResponseHeadersPolicyId": "managed-security-headers"
    },
    "CacheBehaviors": {
      "Quantity": 2,
      "Items": [
        {
          "PathPattern": "/assets/*",
          "TargetOriginId": "nano-bananary-origin",
          "ViewerProtocolPolicy": "https-only",
          "CachePolicyId": "managed-caching-optimized-for-uncompressed-objects",
          "TTL": 31536000
        },
        {
          "PathPattern": "*.html",
          "TargetOriginId": "nano-bananary-origin",
          "ViewerProtocolPolicy": "https-only",
          "CachePolicyId": "managed-caching-disabled"
        }
      ]
    },
    "CustomErrorResponses": {
      "Quantity": 1,
      "Items": [
        {
          "ErrorCode": 404,
          "ResponsePagePath": "/index.html",
          "ResponseCode": "200",
          "ErrorCachingMinTTL": 300
        }
      ]
    },
    "Enabled": true,
    "PriceClass": "PriceClass_100"
  }
}
```

### 7.3 性能监控

#### 7.3.1 Google Analytics配置

**添加到index.html**:
```html
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'GA_MEASUREMENT_ID');
</script>
```

#### 7.3.2 性能监控代码

**src/utils/analytics.ts**:
```typescript
/**
 * 性能监控工具
 */

// 页面加载性能
export function trackPageLoad() {
  if ('performance' in window) {
    window.addEventListener('load', () => {
      const perfData = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      
      // 发送性能数据
      gtag('event', 'page_load_time', {
        event_category: 'Performance',
        event_label: 'Page Load',
        value: Math.round(perfData.loadEventEnd - perfData.fetchStart)
      });
    });
  }
}

// API调用性能
export function trackAPICall(endpoint: string, duration: number, success: boolean) {
  gtag('event', 'api_call', {
    event_category: 'API',
    event_label: endpoint,
    value: Math.round(duration),
    custom_parameter_1: success ? 'success' : 'error'
  });
}

// 用户行为追踪
export function trackUserAction(action: string, category: string = 'User') {
  gtag('event', action, {
    event_category: category,
    event_label: action
  });
}
```

## 8. 监控和运维

### 8.1 日志管理

#### 8.1.1 Nginx日志配置

**自定义日志格式**:
```nginx
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time '
                   '$pipe $connection_requests';

access_log /var/log/nginx/nano-bananary.access.log detailed;
```

#### 8.1.2 日志轮转配置

**/etc/logrotate.d/nano-bananary**:
```
/var/log/nginx/nano-bananary*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}
```

### 8.2 健康检查

#### 8.2.1 应用健康检查

**health-check.sh**:
```bash
#!/bin/bash

# 健康检查脚本
HOST="localhost"
PORT="80"
TIMEOUT="5"

# 检查HTTP响应
response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout $TIMEOUT http://$HOST:$PORT/)

if [ $response -eq 200 ]; then
    echo "Health check passed: HTTP $response"
    exit 0
else
    echo "Health check failed: HTTP $response"
    exit 1
fi
```

#### 8.2.2 监控脚本

**monitor.sh**:
```bash
#!/bin/bash

# 系统监控脚本
LOG_FILE="/var/log/nano-bananary-monitor.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# 检查磁盘空间
disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $disk_usage -gt 80 ]; then
    echo "[$TIMESTAMP] WARNING: Disk usage is ${disk_usage}%" >> $LOG_FILE
fi

# 检查内存使用
mem_usage=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
if [ $mem_usage -gt 80 ]; then
    echo "[$TIMESTAMP] WARNING: Memory usage is ${mem_usage}%" >> $LOG_FILE
fi

# 检查服务状态
if ! systemctl is-active --quiet nginx; then
    echo "[$TIMESTAMP] ERROR: Nginx service is not running" >> $LOG_FILE
    systemctl restart nginx
fi

# 检查应用可访问性
if ! curl -f -s http://localhost/ > /dev/null; then
    echo "[$TIMESTAMP] ERROR: Application is not accessible" >> $LOG_FILE
fi
```

### 8.3 备份策略

#### 8.3.1 自动备份脚本

**backup.sh**:
```bash
#!/bin/bash

# 备份配置
BACKUP_DIR="/backup/nano-bananary"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份应用文件
tar -czf $BACKUP_DIR/app_$DATE.tar.gz /var/www/nano-bananary/

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz /etc/nginx/sites-available/nano-bananary

# 备份日志文件
tar -czf $BACKUP_DIR/logs_$DATE.tar.gz /var/log/nginx/nano-bananary*.log

# 清理旧备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $DATE"
```

#### 8.3.2 定时任务配置

```bash
# 编辑crontab
crontab -e

# 添加定时任务
# 每天凌晨2点备份
0 2 * * * /path/to/backup.sh

# 每5分钟健康检查
*/5 * * * * /path/to/health-check.sh

# 每小时系统监控
0 * * * * /path/to/monitor.sh
```

## 9. 安全配置

### 9.1 HTTPS配置

#### 9.1.1 SSL证书获取

**使用Let's Encrypt**:
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 验证证书
sudo certbot certificates

# 测试自动续期
sudo certbot renew --dry-run
```

#### 9.1.2 SSL安全配置

**强化SSL配置**:
```nginx
# SSL协议和加密套件
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
ssl_prefer_server_ciphers off;

# SSL会话缓存
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# OCSP装订
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /path/to/chain.pem;

# HSTS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
```

### 9.2 安全头部配置

#### 9.2.1 完整安全头部

```nginx
# 内容安全策略
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://generativelanguage.googleapis.com https://www.google-analytics.com; frame-ancestors 'none';" always;

# XSS保护
add_header X-XSS-Protection "1; mode=block" always;

# 内容类型嗅探保护
add_header X-Content-Type-Options "nosniff" always;

# 点击劫持保护
add_header X-Frame-Options "DENY" always;

# 引用策略
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# 权限策略
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
```

### 9.3 访问控制

#### 9.3.1 IP白名单（管理接口）

```nginx
# 管理接口访问控制
location /admin {
    allow 192.168.1.0/24;
    allow 10.0.0.0/8;
    deny all;
    
    # 基本认证
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

#### 9.3.2 速率限制

```nginx
# 定义速率限制区域
http {
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general:10m rate=1r/s;
}

server {
    # API接口限制
    location /api/ {
        limit_req zone=api burst=20 nodelay;
    }
    
    # 一般请求限制
    location / {
        limit_req zone=general burst=5 nodelay;
    }
}
```

## 10. 故障排除

### 10.1 常见问题

#### 10.1.1 部署失败

**问题**: 构建失败
```bash
# 检查Node.js版本
node --version

# 清理缓存
npm cache clean --force
rm -rf node_modules package-lock.json
npm install

# 检查环境变量
echo $VITE_API_KEY
```

**问题**: 静态资源404
```nginx
# 检查文件权限
ls -la /var/www/nano-bananary/

# 修正权限
sudo chown -R www-data:www-data /var/www/nano-bananary/
sudo chmod -R 755 /var/www/nano-bananary/
```

#### 10.1.2 性能问题

**问题**: 加载缓慢
```bash
# 检查Gzip压缩
curl -H "Accept-Encoding: gzip" -I http://your-domain.com/

# 检查缓存头部
curl -I http://your-domain.com/assets/index.js

# 分析网络性能
wget --spider --server-response http://your-domain.com/
```

### 10.2 日志分析

#### 10.2.1 错误日志分析

```bash
# 查看Nginx错误日志
sudo tail -f /var/log/nginx/nano-bananary.error.log

# 分析访问日志
sudo awk '{print $1}' /var/log/nginx/nano-bananary.access.log | sort | uniq -c | sort -nr | head -10

# 查看响应时间
sudo awk '{print $NF}' /var/log/nginx/nano-bananary.access.log | sort -n | tail -10
```

#### 10.2.2 系统资源监控

```bash
# 检查系统负载
uptime
top
htop

# 检查磁盘空间
df -h
du -sh /var/www/nano-bananary/

# 检查内存使用
free -h

# 检查网络连接
netstat -tulpn | grep :80
ss -tulpn | grep :80
```

### 10.3 应急处理

#### 10.3.1 服务恢复

```bash
# 重启Web服务器
sudo systemctl restart nginx

# 检查服务状态
sudo systemctl status nginx

# 重新加载配置
sudo nginx -t
sudo systemctl reload nginx
```

#### 10.3.2 回滚部署

```bash
# 恢复备份
sudo tar -xzf /backup/nano-bananary/app_YYYYMMDD_HHMMSS.tar.gz -C /

# 重启服务
sudo systemctl restart nginx

# 验证恢复
curl -I http://your-domain.com/
```

---

本部署文档涵盖了Nano Bananary项目的完整部署流程，从本地开发到生产环境的各种部署方式。请根据实际需求选择合适的部署方案，并定期更新和维护部署环境。