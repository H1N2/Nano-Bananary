# Nano Bananary 技术设计文档

## 1. 系统概述

### 1.1 技术栈
- **前端框架**：React 19.1.1
- **开发语言**：TypeScript 5.8.2
- **构建工具**：Vite 6.2.0
- **AI服务**：Google Gemini API (@google/genai 1.17.0)
- **样式方案**：内联样式 + CSS动画
- **状态管理**：React Hooks + LocalStorage

### 1.2 架构模式
- **架构类型**：单页应用（SPA）
- **设计模式**：组件化架构
- **数据流**：单向数据流
- **状态管理**：本地状态 + 持久化存储

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                              │
├─────────────────────────────────────────────────────────────┤
│  App.tsx (主应用)                                            │
│  ├── TransformationSelector (变换选择器)                      │
│  ├── ImageUploader (图像上传器)                               │
│  ├── MultiImageUploader (多图上传器)                          │
│  ├── ImageEditorCanvas (图像编辑画布)                         │
│  ├── ResultDisplay (结果展示)                                │
│  ├── HistoryPanel (历史面板)                                 │
│  └── 其他UI组件                                              │
├─────────────────────────────────────────────────────────────┤
│                        业务逻辑层                              │
│  ├── 图像处理逻辑                                            │
│  ├── 状态管理逻辑                                            │
│  ├── 文件处理逻辑                                            │
│  └── 用户交互逻辑                                            │
├─────────────────────────────────────────────────────────────┤
│                        服务层                                 │
│  ├── geminiService.ts (AI服务接口)                           │
│  ├── fileUtils.ts (文件工具)                                 │
│  └── 其他工具服务                                            │
├─────────────────────────────────────────────────────────────┤
│                        数据层                                 │
│  ├── LocalStorage (本地存储)                                 │
│  ├── 内存状态管理                                            │
│  └── 临时文件处理                                            │
├─────────────────────────────────────────────────────────────┤
│                        外部服务                               │
│  └── Google Gemini AI API                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 核心模块
- **App模块**：应用主入口，负责整体状态管理和组件协调
- **组件模块**：可复用的UI组件，负责用户交互和数据展示
- **服务模块**：业务逻辑处理，包括AI服务调用和文件处理
- **工具模块**：通用工具函数，提供基础功能支持

#### 2.2.2 数据模块
- **类型定义**：TypeScript类型定义，确保类型安全
- **常量配置**：应用配置和预设数据
- **状态管理**：应用状态的定义和管理

## 3. 核心组件设计

### 3.1 App组件（主应用）

#### 3.1.1 职责
- 应用状态管理
- 组件间通信协调
- 业务流程控制
- 错误处理和加载状态管理

#### 3.1.2 主要状态
```typescript
interface AppState {
  // 变换相关
  transformations: Transformation[];
  selectedTransformation: Transformation | null;
  
  // 图像相关
  primaryImageUrl: string | null;
  primaryFile: File | null;
  secondaryImageUrl: string | null;
  secondaryFile: File | null;
  
  // 结果相关
  generatedContent: GeneratedContent | null;
  
  // UI状态
  isLoading: boolean;
  loadingMessage: string;
  error: string | null;
  
  // 编辑相关
  activeTool: 'mask' | 'none';
  maskCanvas: string | null;
  
  // 历史记录
  history: HistoryItem[];
  
  // 其他UI状态
  showImagePreview: boolean;
  showHistory: boolean;
}
```

#### 3.1.3 核心方法
- `handleTransformationSelect()`: 处理变换选择
- `handleImageUpload()`: 处理图像上传
- `handleGenerate()`: 处理图像生成
- `handleMaskUpdate()`: 处理蒙版更新
- `handleHistoryItemClick()`: 处理历史记录点击

### 3.2 TransformationSelector组件

#### 3.2.1 职责
- 展示可用的图像变换选项
- 处理变换选择交互
- 支持拖拽排序功能
- 提供搜索和筛选功能

#### 3.2.2 组件接口
```typescript
interface TransformationSelectorProps {
  transformations: Transformation[];
  selectedTransformation: Transformation | null;
  onTransformationSelect: (transformation: Transformation) => void;
  onTransformationsReorder: (transformations: Transformation[]) => void;
}
```

### 3.3 ImageEditorCanvas组件

#### 3.3.1 职责
- 提供图像编辑画布
- 支持蒙版绘制功能
- 处理鼠标/触摸交互
- 管理画布状态

#### 3.3.2 核心功能
- Canvas绘制API
- 鼠标事件处理
- 蒙版数据生成
- 画布缩放和平移

### 3.4 其他关键组件

#### MultiImageUploader
- 支持多图像上传
- 图像预览和管理
- 拖拽上传功能

#### ResultDisplay
- 生成结果展示
- 图像预览功能
- 下载和分享功能

#### HistoryPanel
- 编辑历史记录
- 快速回滚功能
- 历史项目管理

## 4. 服务层设计

### 4.1 GeminiService

#### 4.1.1 核心功能
- Google Gemini API集成
- 图像处理请求封装
- 错误处理和重试机制
- 请求参数优化

#### 4.1.2 主要方法
```typescript
/**
 * 编辑图像的核心方法
 * @param base64ImageData 主图像的base64数据
 * @param mimeType 图像MIME类型
 * @param prompt 处理提示词
 * @param maskBase64 蒙版数据（可选）
 * @param secondaryImage 辅助图像（可选）
 * @returns 生成的内容结果
 */
export async function editImage(
  base64ImageData: string,
  mimeType: string,
  prompt: string,
  maskBase64: string | null,
  secondaryImage: { base64: string; mimeType: string } | null
): Promise<GeneratedContent>
```

#### 4.1.3 请求处理流程
1. 参数验证和预处理
2. 构建API请求参数
3. 发送请求到Gemini API
4. 处理响应数据
5. 错误处理和重试
6. 返回标准化结果

### 4.2 FileUtils

#### 4.2.1 核心功能
- 文件格式转换
- 图像处理工具
- 水印添加功能
- 文件下载管理

#### 4.2.2 主要方法
- `dataUrlToFile()`: DataURL转File对象
- `loadImage()`: 图像加载
- `resizeImageToMatch()`: 图像尺寸调整
- `embedWatermark()`: 水印嵌入
- `downloadImage()`: 图像下载

## 5. 数据流设计

### 5.1 用户操作流程
```
用户选择变换 → 上传图像 → [可选]绘制蒙版 → 生成处理 → 查看结果 → [可选]继续编辑
```

### 5.2 数据传递路径
```
UI组件 → App状态 → 服务层 → 外部API → 服务层 → App状态 → UI组件
```

### 5.3 状态更新机制
- 使用React Hooks进行状态管理
- 通过回调函数实现组件间通信
- LocalStorage实现状态持久化
- 错误边界处理异常状态

## 6. 性能优化设计

### 6.1 图像处理优化
- **图像压缩**：上传前自动压缩大尺寸图像
- **格式优化**：优先使用WebP等高效格式
- **缓存机制**：缓存处理结果避免重复请求
- **懒加载**：按需加载图像资源

### 6.2 组件性能优化
- **React.memo**：避免不必要的组件重渲染
- **useCallback**：缓存事件处理函数
- **useMemo**：缓存计算结果
- **代码分割**：按需加载组件代码

### 6.3 网络优化
- **请求合并**：合并多个API请求
- **错误重试**：实现智能重试机制
- **超时处理**：设置合理的请求超时时间
- **进度反馈**：提供处理进度信息

## 7. 安全设计

### 7.1 API安全
- **密钥管理**：环境变量存储API密钥
- **请求验证**：验证请求参数合法性
- **错误处理**：避免敏感信息泄露
- **访问控制**：限制API调用频率

### 7.2 数据安全
- **本地处理**：图像数据仅在客户端处理
- **临时存储**：避免长期存储用户数据
- **数据清理**：及时清理临时文件
- **隐私保护**：不收集用户个人信息

### 7.3 输入验证
- **文件类型检查**：验证上传文件格式
- **文件大小限制**：限制上传文件大小
- **内容过滤**：过滤恶意内容
- **XSS防护**：防止跨站脚本攻击

## 8. 错误处理设计

### 8.1 错误分类
- **网络错误**：API请求失败
- **文件错误**：文件格式或大小问题
- **处理错误**：AI处理失败
- **系统错误**：应用运行时错误

### 8.2 错误处理策略
- **用户友好提示**：提供清晰的错误信息
- **自动重试**：对临时性错误进行重试
- **降级处理**：提供备选方案
- **错误日志**：记录错误信息用于调试

### 8.3 错误恢复机制
- **状态回滚**：错误时恢复到上一个稳定状态
- **部分功能降级**：核心功能优先保证
- **用户引导**：提供解决问题的建议
- **反馈收集**：收集用户反馈改进产品

## 9. 扩展性设计

### 9.1 功能扩展
- **插件机制**：支持第三方变换插件
- **模板系统**：支持自定义变换模板
- **API扩展**：支持多种AI服务提供商
- **格式支持**：扩展更多图像格式支持

### 9.2 架构扩展
- **微服务化**：将功能拆分为独立服务
- **状态管理升级**：引入Redux等状态管理库
- **组件库化**：将组件抽象为独立库
- **多端支持**：扩展到移动端和桌面端

### 9.3 性能扩展
- **CDN集成**：使用CDN加速资源加载
- **服务端渲染**：提升首屏加载速度
- **缓存策略**：实现多层缓存机制
- **负载均衡**：支持高并发访问

## 10. 部署和运维

### 10.1 构建配置
- **Vite配置**：优化构建性能和输出
- **TypeScript配置**：严格类型检查
- **环境变量**：区分开发和生产环境
- **代码压缩**：最小化输出文件大小

### 10.2 部署策略
- **静态部署**：部署到CDN或静态托管服务
- **容器化**：使用Docker进行容器化部署
- **CI/CD**：自动化构建和部署流程
- **版本管理**：实现灰度发布和回滚

### 10.3 监控和维护
- **性能监控**：监控应用性能指标
- **错误追踪**：收集和分析错误信息
- **用户行为分析**：了解用户使用模式
- **定期更新**：保持依赖库的安全更新

## 11. 开发规范

### 11.1 代码规范
- **TypeScript严格模式**：启用严格类型检查
- **ESLint配置**：统一代码风格
- **Prettier格式化**：自动代码格式化
- **注释规范**：函数级注释要求

### 11.2 组件规范
- **单一职责**：每个组件只负责一个功能
- **Props接口**：明确定义组件接口
- **状态最小化**：减少不必要的状态
- **可复用性**：提高组件复用性

### 11.3 文件组织
- **模块化结构**：按功能模块组织文件
- **命名规范**：使用有意义的文件和变量名
- **导入导出**：统一的导入导出方式
- **目录结构**：清晰的目录层次结构

## 12. 测试策略

### 12.1 测试类型
- **单元测试**：测试独立功能模块
- **集成测试**：测试组件间交互
- **端到端测试**：测试完整用户流程
- **性能测试**：测试应用性能表现

### 12.2 测试工具
- **Jest**：JavaScript测试框架
- **React Testing Library**：React组件测试
- **Cypress**：端到端测试工具
- **Lighthouse**：性能测试工具

### 12.3 测试覆盖率
- **代码覆盖率**：目标80%以上
- **功能覆盖率**：核心功能100%覆盖
- **边界测试**：测试边界条件和异常情况
- **回归测试**：确保新功能不影响现有功能